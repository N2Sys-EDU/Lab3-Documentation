# Lab3

Lab3分为两个部分：
1. 使用ebpf技术，实现一个NAT，实现内网和外网的通信。
2. 使用ebpf技术，基于UDP协议，实现一个简单的代理。

## 1.网络结构

在Lab3中，我们考虑一个日常生活中使用的网络结构。

![](net.png)

我们的实际网络拓扑如左图所示，为了简化实验，我们对网络拓扑做出如下假设：
1. 网络不存在嵌套的情况，即只有广域网和局域网两层，并且路由器只有一个接口连接到广域网。
2. 每台机器均有一个所在网段的唯一IP地址。
3. 广域网中的所有机器，通过一个交换机连接。
4. 我们规定，局域网的网段为192.168.1.0/24，广域网的网段为10.0.0.0/8。
5. 存在一台机器，能够和所有机器通信，该机器在广域网中，并且其广域网地址(三层)被所有其他机器知晓。
6. 除路由器外的计算机均只有一个端口，或者连接到路由器，或者连接到广域网。

## 2. 功能要求

这一节将描述你要实现的三个程序的功能，他们分别是NAT、代理客户端和代理服务端。
他们的运行位置如图所示：
![](proxy_pos.png)

### NAT

对于存在广域网端口的路由器，它需要支持NAT功能。
该功能需要用ebpf实现，并部署在路由器的和广域网连接的端口上。

对于来自局域网端口的报文，若下一跳将从广域网端口发出，则需要执行网络地址转换。
即若该报文源地址尚未分配广域网地址，则需要为该源地址分配一个可用广域网地址，并将报文中的源地址替换为对应广域网地址后再发出。
若没有空闲的可用广域网地址，则丢弃该报文。
若已分配地址，则直接将源地址转换为对应广域网地址后发出。
对于来自广域网端口的报文，若其目的地址不是该路由器已分配的广域网地址，则直接丢弃。
否则将目的地址转换为对应的局域网地址后再上交给内核网络协议栈。

### 代理客户端

代理客户端是一个ebpf程序，运行在每台**局域网**普通机器的连接到网络的接口的**egress**上。
我们会提供一个规则列表，如果一个即将发送的报文命中了规则列表中的某个规则，则意味着该报文如果直接发送，接收方会拒绝。
因此代理客户端需要将这个报文转发给代理服务端。

更具体的来说，一个即将发送的报文的报文头部为：
```
|IP|TCP/UDP|Data|
```
在命中后，这个报文会被修改为：
```
|IP to 代理服务端|UDP to 代理服务端｜IP|TCP/UDP|Data|
```
这个报文会被发送给代理服务端。

> 更有趣的是，你可以在这里对你的报文内容进行加密（不是课程要求）

### 代理服务端

代理服务端是一个ebpf程序，运行在广域网中某台机器网络接口的**ingress**上。
通过代理服务器，局域网内的机器和目标机器进行通信。
代理服务器的工作分为两个部分：监听来自代理客户端的报文，以及转发来自目标机器的报文。

首先，代理服务端会通过ebpf监听某个特定端口上的，来自来自代理客户端的报文。
其格式均为
```
|IP to 代理服务端|UDP to 代理服务端｜IP|TCP/UDP|Data|
```
我们将报文恢复为原本的格式，并进行转发。
```
｜IP|TCP/UDP|Data|
```
但是，我们需要伪装成从代理服务器访问该报文的目标机器。
因此，我们需要对源地址进行替换。
即若该报文源地址尚未分配一个代理服务器的广域网地址，则需要为该源地址分配一个可用广域网地址，并将报文中的源地址替换为对应广域网地址后再发出。

其次，如果一个报文的目的地址不是已经被分配的地址，则上交给内核协议栈处理。
否则，我们将该报文的目的地址修改为该广域网地址对应的源地址，然后转发回互联网即可。

## 3. 技术规范

## 4. 本地运行与测试

## 5. 分数计算
