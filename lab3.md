# Lab3

在 Lab 3 中，你需要实现一个简单的运行 DV 算法并支持 NAT 功能的路由器。

## 1. 网络结构

在 Lab 3 中，我们对网络拓扑进行了简化，如下图所示

![](net.png)

若干路由器之间以任意方式连接成图，每个路由器只能有最多一个内网端口，但可以有多个与其相连的 host。为了简单起见，每台 host 均有唯一的 IP 地址且只能连接一台路由器，而路由器不具有 IP 地址。网络中存在一个为了 Lab 测试而存在的 Controller 节点，它与每台路由器均相连。 

我们规定路由器与内网连接的边权 cost 为 0，并且忽略内网内部的 cost。 Controller 与路由器之间的边权也为 0。

> 注意，这里定义的网络结构与现实中的结构并不相同。


## 2. 功能要求

这一节将概括性的描述你需要实现的路由器功能。

你实现的路由器程序将被部署到每一台路由器上。总的来说，它需要支持在接收到一个报文后，根据目的地址决定转发到哪一个端口，另外需要实现网络地址转换 (NAT) 以支持内网对公网的访问。

### 2.1. 路由算法

我们希望你的路由器程序使用距离矢量算法，因为之后的接口设计将基于这一假设。你的路由器应当能够通过不断地信息交换最终得到到达任意可达 host 的最短路径，特别地，你也应该能够得出到达经过 NAT 转换后的地址的最短路径。

路由器在收到数据报文时应当按照计算得到的最短路径进行转发。

### 2.2. NAT

另一方面，对于存在内网端口的路由器，它需要支持最基础的 NAT 功能，在 Lab 3 中，它包括：

1. 每个路由器需支持配置最多 256 个可用公网地址。
2. 对于源地址为内网地址的报文，若该源地址尚未分配公网地址，则需要为该源地址分配一个可用公网地址，并在转发前将报文中的内网地址替换为对应公网地址。
3. 对于收到的报文，应当检查目的地址是否是该路由器的可用公网地址，若是，则检查是否为 2 中已分配的地址，若是则将其替换为对应的内网地址并转发到内网端口，若不是已分配的地址，则丢弃该报文。

### 2.3 Controller

你不需要实现 Controller，但为了进行测试，你需要能够接收来自 Controller 的控制信息，并作出相应的操作。我们将在下一节中具体描述控制信息的内容。

## 3. 技术规范

### 3.1. 报文格式

在 Lab 3 中，每一个报文仅包含一个报头，其格式如下：

```cpp
struct {
    uint32_t    src;
    uint32_t    dst;
    uint8_t     type;
    uint16_t    length;
};
```

`src` 和 `dst` 字段分别表示源和目的 IPv4 地址。

`length` 字段为报头后的 payload 长度。

`type` 字段有三个取值，分别为 `TYPE_DV` , `TYPE_DATA` 和 `TYPE_CONTROL` 。其值分别为

```cpp
uint8_t TYPE_DV         = 0x00;
uint8_t TYPE_DATA       = 0x01;
uint8_t TYPE_CONTROL    = 0x02;
```

对于 `TYPE_DATA` ，其后仅包含数据。路由器应当转发该种报文，并且保持 payload 不变，测试时将会检查 payload 。

对于 `TYPE_DV` ，该种报文用于允许在路由器之间交换距离向量，你可以自己定义其后的 payload 格式和内容。另外，路由器收到该类型报文时的行为也是自定义的，测试时将不会检查该类型报文的内容。

对于 `TYPE_CONTROL` ，该种报文仅由 Controller 发出，其 payload 包含一条指令**字符串** 。

**注意，`src` 与 `dst` 字段为大端法表示，其余字段均为小端法表示**

### 3.2. 控制指令

控制指令是包含在 CONTROL 报文中的**字符串**。

每条控制指令形如 `<type> <param1> ...` ，其中 `<type>` 为整数，用于指示该条指令的类型。

你的路由器需要支持的控制指令如下：

|  command          | `<type>`  |
|  ----             | ----      |
| TRIGGER DV SEND   |  0     |
| RELEASE NAT ITEM  |  1     |
| PORT VALUE CHANGE |  2     |
| ADD HOST          |  3     |

注意该表给出了每个类型对应的 `<type>` 字段的值。

#### 3.2.1. TRIGGER DV SEND

该指令仅包含 `<type>` ，路由器应当在收到该指令后主动发起一次距离向量交换。

#### 3.2.2 RELEASE NAT ITEM

该指令格式为 `<type> <internal_ip>` ，其中 `<internal_ip>` 为一个点分十进制表示的内网 IPv4 地址，例如 `1 10.0.0.0` 。路由器在收到该指令后，应当将 `<internal_ip>` 拥有的已分配公网地址释放，该内网地址不再拥有公网地址直到再次被分配。

#### 3.2.3 PORT VALUE CHANGE

该指令格式为 `<type> <port> <value>` ，其中 `<port>` , `<value>` 均为整数值，例如 `2 5 6` 。该条指令意为将路由器的 `<port>` 端口的权值更新为 `<value>` 。路由器在收到该指令后，应当更新端口对应的权值。

**特别的， `<value>` 为 `-1` 时意为该端口被关闭**。

#### 3.2.4 ADD HOST

该指令格式为 `<type> <port> <value> <ip>` ，其中 `<port>` , `value` 为整数值， `ip` 为一个点分十进制表示的公网地址，例如 `3 2 10 114.114.114.114` 。该条指令通知路由器在 `<port>` 端口上连接了一台 IPv4 地址为 `<ip>` 的 host，链路 cost 为 `<value>` 。路由器收到该指令后应该更新路由。

## 4. 实现要求

### 4.1. 路由器接口

### 4.2. 控制器工作流

### 4.3. 测试要求

## 5. 本地测试

### 5.1 debug mode

### 5.2 test mode

## 6. 分数计算

